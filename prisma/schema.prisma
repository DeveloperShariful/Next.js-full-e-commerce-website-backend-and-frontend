// ==========================================
// FIXED PRISMA SCHEMA - ALL CRITICAL ISSUES RESOLVED
// ==========================================

// ==========================================
// 1. CONFIGURATION
// ==========================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "fullTextSearchPostgres", "tracing", "relationJoins"]
  engineType      = "library"
}

datasource db {
  provider   = "postgresql"
  extensions = [pg_trgm, unaccent, pgvector(map: "vector", schema: "public")]
}

// ==========================================
// 2. ENUMS
// ==========================================

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  EDITOR
  SUPPORT
  CUSTOMER
  AFFILIATE
}

enum ProductType {
  SIMPLE
  VARIABLE
  VIRTUAL
  DOWNLOADABLE
  BUNDLE
  GIFT_CARD
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum OrderStatus {
  DRAFT
  PENDING
  AWAITING_PAYMENT
  PROCESSING
  PACKED
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  FAILED
  RETURNED
  READY_FOR_PICKUP
}

enum PaymentStatus {
  UNPAID
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  VOIDED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  RETURNED
  PICKED_UP
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
  BUY_X_GET_Y
  FIXED_CART
  FIXED_PRODUCT
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  RECEIVED
  REFUNDED
}

enum TransactionType {
  SALE
  REFUND
  VOID
  DISPUTE
  CHARGEBACK
}

enum BackorderStatus {
  DO_NOT_ALLOW
  ALLOW
  ALLOW_BUT_NOTIFY
}

enum TaxStatus {
  TAXABLE
  SHIPPING_ONLY
  NONE
}

enum AddressType {
  BILLING
  SHIPPING
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
  ARCHIVE
}

enum ShippingMethodType {
  FLAT_RATE
  FREE_SHIPPING
  LOCAL_PICKUP
  CARRIER_CALCULATED
}

enum PaymentMode {
  TEST
  LIVE
}

enum PaymentIntent {
  CAPTURE
  AUTHORIZE
}

enum PayPalButtonColor {
  GOLD
  BLUE
  SILVER
  WHITE
  BLACK
}

enum PayPalButtonShape {
  PILL
  RECT
}

enum PayPalButtonLayout {
  VERTICAL
  HORIZONTAL
}

enum PayPalButtonLabel {
  PAYPAL
  CHECKOUT
  BUYNOW
  PAY
}

enum PayPalLandingPage {
  LOGIN
  BILLING
  NO_PREFERENCE
}

enum PaymentHandlerType {
  ONLINE
  OFFLINE
}

enum DisputeStatus {
  WARNING_NEEDS_RESPONSE
  NEEDS_RESPONSE
  UNDER_REVIEW
  WON
  LOST
}

enum NotificationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

enum EventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AffiliateStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
}

enum CommissionType {
  PERCENTAGE
  FIXED
}

enum PayoutMethod {
  BANK_TRANSFER
  PAYPAL
  STORE_CREDIT
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ReferralStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum LedgerType {
  COMMISSION
  PAYOUT
  ADJUSTMENT
  BONUS
  REFUND_DEDUCTION
}

// ==========================================
// 3. USER, AUTH & SYSTEM
// ==========================================

model User {
  id                    String    @id @default(uuid())
  clerkId               String?   @unique
  name                  String?
  email                 String    @unique
  emailVerified         DateTime?
  password              String?
  phone                 String?   @unique
  image                 String?
  mediaId               String?
  media                 Media?    @relation(fields: [mediaId], references: [id])
  role                  Role      @default(CUSTOMER)
  isActive              Boolean   @default(true)
  dateOfBirth           DateTime?
  gender                String?
  notes                 String?
  metafields            Json?
  deletedAt             DateTime?
  version               Int       @default(1)

  // Audit fields
  createdBy             String?
  updatedBy             String?

  addresses             Address[]
  paymentMethods        UserPaymentMethod[]
  orders                Order[]
  reviews               Review[]
  wishlist              Wishlist[]
  cart                  Cart?
  viewedProducts        RecentlyViewed[]
  wallet                Wallet?
  abandonedCheckouts    AbandonedCheckout[]

  activityLogs          ActivityLog[]
  blogPosts             BlogPost[]
  notifications         Notification[]

  createdTickets        SupportTicket[] @relation("UserCreatedTickets")
  assignedTickets       SupportTicket[] @relation("StaffTickets")

  affiliateAccount      AffiliateAccount?
  referredByAffiliateId String?
  referredByAffiliate   AffiliateAccount? @relation("CustomerReferral", fields: [referredByAffiliateId], references: [id], onDelete: SetNull)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([email])
  @@index([phone])
  @@index([role, createdAt(sort: Desc)])
  @@index([clerkId])
  @@index([role, isActive])
  @@index([deletedAt])
}

model UserPaymentMethod {
  id                 String   @id @default(uuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  gateway            String
  type               String
  gatewayCustomerId  String?
  paymentMethodId    String
  fingerprint        String?
  paypalEmail        String?
  billingAgreementId String?
  brand              String?
  last4              String?
  expiryMonth        Int?
  expiryYear         Int?
  billingDetails     Json?
  isDefault          Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId])
}

model Address {
  id                    String      @id @default(uuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  title                 String?
  type                  AddressType @default(SHIPPING)
  firstName             String
  lastName              String
  company               String?
  address1              String
  address2              String?
  city                  String
  state                 String?
  postcode              String
  country               String
  phone                 String
  email                 String?
  locationType          String?
  transdirectLocationId String?
  isResidential         Boolean     @default(true)
  isDefault             Boolean     @default(false)
  taxZoneId             String?
  isVerified            Boolean     @default(false)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@index([userId])
  @@index([type])
}

model Wallet {
  id           String              @id @default(uuid())
  userId       String              @unique
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance      Decimal             @default(0.00) @db.Decimal(12, 2)
  points       Int                 @default(0)
  version      Int                 @default(1)
  transactions WalletTransaction[]
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
}

model WalletTransaction {
  id          String          @id @default(uuid())
  walletId    String
  wallet      Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
  amount      Decimal         @db.Decimal(12, 2)
  type        TransactionType
  description String?
  reference   String?
  createdAt   DateTime        @default(now())

  @@index([walletId])
  @@index([createdAt(sort: Desc)])
}

// ==========================================
// 4. PRODUCT CATALOG & I18N
// ==========================================

model Category {
  id                      String                @id @default(uuid())
  name                    String
  slug                    String                @unique
  description             String?               @db.Text
  image                   String?
  mediaId                 String?
  media                   Media?                @relation(fields: [mediaId], references: [id])
  isActive                Boolean               @default(true)
  menuOrder               Int                   @default(0)
  parentId                String?
  parent                  Category?             @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull)
  children                Category[]            @relation("CategoryToCategory")
  products                Product[]
  translations            CategoryTranslation[]
  metafields              Json?
  metaTitle               String?
  metaDesc                String?
  affiliateCommissionRate Decimal?              @db.Decimal(5, 2)
  disableAffiliate        Boolean               @default(false)
  deletedAt               DateTime?
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt

  @@index([parentId])
  @@index([isActive, menuOrder(sort: Asc)])
  @@index([deletedAt])
}

model CategoryTranslation {
  id          String   @id @default(uuid())
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  language    String
  name        String
  description String?  @db.Text
  metaTitle   String?
  metaDesc    String?

  @@unique([categoryId, language])
}

model Brand {
  id                String             @id @default(uuid())
  name              String
  slug              String             @unique
  logo              String?
  logoMediaId       String?
  logoMedia         Media?             @relation(fields: [logoMediaId], references: [id])
  description       String?            @db.Text
  website           String?
  countryOfOrigin   String?
  products          Product[]
  productAttributes ProductAttribute[]
  metaTitle         String?
  metaDesc          String?
  metafields        Json?
  deletedAt         DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([name])
  @@index([deletedAt])
}

model Tag {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String    @unique
  description String?   @db.Text
  color       String?
  metafields  Json?
  deletedAt   DateTime?
  metaTitle   String?
  metaDesc    String?
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([deletedAt])
}

model Collection {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?   @db.Text
  image       String?
  mediaId     String?
  media       Media?    @relation(fields: [mediaId], references: [id])
  isActive    Boolean   @default(true)
  startDate   DateTime?
  endDate     DateTime?
  products    Product[]
  metaTitle   String?
  metaDesc    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive])
}

model ShippingClass {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Product {
  id                       String                 @id @default(uuid())
  versions                 ProductVersion[]
  stockHistory             StockHistory[]
  productCode              Int                    @unique @default(autoincrement())
  name                     String
  slug                     String                 @unique
  description              String?                @db.Text
  shortDescription         String?                @db.Text
  productType              ProductType            @default(SIMPLE)
  status                   ProductStatus          @default(DRAFT)
  isFeatured               Boolean                @default(false)
  categoryId               String?
  category                 Category?              @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  brandId                  String?
  brand                    Brand?                 @relation(fields: [brandId], references: [id], onDelete: SetNull)
  tags                     Tag[]
  collections              Collection[]
  featuredImage            String?
  featuredMediaId          String?
  featuredMedia            Media?                 @relation(fields: [featuredMediaId], references: [id])
  images                   ProductImage[]
  videoUrl                 String?
  videoThumbnail           String?
  price                    Decimal                @default(0.00) @db.Decimal(12, 2)
  salePrice                Decimal?               @db.Decimal(12, 2)
  saleStart                DateTime?
  saleEnd                  DateTime?
  costPerItem              Decimal?               @db.Decimal(12, 2)
  taxable                  Boolean                @default(true)
  taxStatus                TaxStatus              @default(TAXABLE)
  taxRateId                String?
  taxRate                  TaxRate?               @relation(fields: [taxRateId], references: [id])
  taxClassId               String?
  sku                      String?                @unique
  barcode                  String?
  mpn                      String?
  trackQuantity            Boolean                @default(true)
  stock                    Int                    @default(0)
  lowStockThreshold        Int                    @default(2)
  backorderStatus          BackorderStatus        @default(DO_NOT_ALLOW)
  soldIndividually         Boolean                @default(false)
  isPreOrder               Boolean                @default(false)
  preOrderReleaseDate      DateTime?
  preOrderMessage          String?
  preOrderLimit            Int?
  weight                   Decimal?               @default(0) @db.Decimal(10, 3)
  length                   Decimal?               @db.Decimal(10, 2)
  width                    Decimal?               @db.Decimal(10, 2)
  height                   Decimal?               @db.Decimal(10, 2)
  weightUnit               String?                @default("kg")
  dimensionUnit            String?                @default("cm")
  shippingClassId          String?
  shippingClass            ShippingClass?         @relation(fields: [shippingClassId], references: [id])
  isVirtual                Boolean                @default(false)
  isDownloadable           Boolean                @default(false)
  downloadFiles            DigitalFile[]
  downloadLimit            Int?
  downloadExpiry           Int?
  isDangerousGood          Boolean                @default(false)
  dangerousGoodType        String?
  hsCode                   String?
  countryOfManufacture     String?
  bundleItems              BundleItem[]           @relation("BundleParent")
  partOfBundles            BundleItem[]           @relation("BundleChild")
  attributes               ProductAttribute[]
  variants                 ProductVariant[]
  reviews                  Review[]
  questions                QuestionAnswer[]
  inventoryLevels          InventoryLevel[]
  translations             ProductTranslation[]
  upsellIds                String[]
  crossSellIds             String[]
  metaTitle                String?
  metaDesc                 String?
  seoCanonicalUrl          String?
  seoSchema                Json?
  gender                   String?
  ageGroup                 String?
  viewCount                Int                    @default(0)
  soldCount                Int                    @default(0)
  rating                   Decimal                @default(0) @db.Decimal(3, 2)
  reviewCount              Int                    @default(0)
  metafields               Json?
  menuOrder                Int                    @default(0)
  purchaseNote             String?
  enableReviews            Boolean                @default(true)
  affiliateCommissionRate  Decimal?               @db.Decimal(5, 2)
  disableAffiliate         Boolean                @default(false)
  affiliateRates           AffiliateProductRate[]
  deletedAt                DateTime?
  version                  Int                    @default(1)
  
  // FIXED: Vector embeddings using proper pgvector syntax
  descriptionEmbedding     Unsupported("vector(1536)")?
  imageEmbedding           Unsupported("vector(512)")?
  
  wishlistedBy             Wishlist[]
  recentViews              RecentlyViewed[]
  orderItems               OrderItem[]
  cartItems                CartItem[]
  
  // Audit fields
  createdBy                String?
  updatedBy                String?
  
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt

  @@index([slug])
  @@index([categoryId, status])
  @@index([brandId, status])
  @@index([status, isFeatured])
  @@index([price(sort: Asc)])
  @@index([name])
  @@index([createdAt(sort: Desc)])
  @@index([stock(sort: Asc), status])
  @@index([metafields(ops: JsonbPathOps)], type: Gin)
  @@index([categoryId, status, price])
  @@index([brandId, status, isFeatured])
  @@index([status, price, createdAt])
  @@index([isPreOrder])
  @@index([deletedAt])
}

model ProductTranslation {
  id               String  @id @default(uuid())
  productId        String
  product          Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  language         String
  name             String
  description      String? @db.Text
  shortDescription String? @db.Text
  metaTitle        String?
  metaDesc         String?

  @@unique([productId, language])
}

model ProductVersion {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  data      Json
  reason    String?
  createdBy String?
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([createdAt(sort: Desc)])
}

model StockHistory {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId  String?
  locationId String?
  change     Int
  finalStock Int
  reason     String?
  userId     String?
  createdAt  DateTime @default(now())

  @@index([productId, variantId])
  @@index([createdAt(sort: Desc)])
}

model ProductImage {
  id             String          @id @default(uuid())
  url            String
  title          String?
  altText        String?
  width          Int?
  height         Int?
  position       Int             @default(0)
  productId      String
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  mediaId        String?
  media          Media?          @relation(fields: [mediaId], references: [id])
  variantId      String?
  variant        ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  // FIXED: Vector embedding
  imageEmbedding Unsupported("vector(512)")?

  @@index([productId, position(sort: Asc)])
  @@index([variantId])
}

model DigitalFile {
  id          String   @id @default(uuid())
  name        String
  url         String
  fileSize    String?
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  accessCount Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([productId])
}

model BundleItem {
  id              String  @id @default(uuid())
  parentProductId String
  parentProduct   Product @relation("BundleParent", fields: [parentProductId], references: [id], onDelete: Cascade)
  childProductId  String
  childProduct    Product @relation("BundleChild", fields: [childProductId], references: [id], onDelete: Cascade)
  quantity        Int     @default(1)

  @@index([parentProductId])
  @@index([childProductId])
}

// ==========================================
// 5. ATTRIBUTES & VARIANTS
// ==========================================

model Attribute {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  type      String   @default("TEXT")
  values    String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductAttribute {
  id         String  @id @default(uuid())
  name       String
  position   Int     @default(0)
  visible    Boolean @default(true)
  variation  Boolean @default(true)
  isFeatured Boolean @default(false)
  brandId    String?
  brand      Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)
  values     String[]
  productId  String
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([brandId])
}

model ProductVariant {
  id                  String           @id @default(uuid())
  productId           String
  product             Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  name                String
  sku                 String?
  barcode             String?
  price               Decimal          @db.Decimal(12, 2)
  salePrice           Decimal?         @db.Decimal(12, 2)
  costPerItem         Decimal?         @db.Decimal(12, 2)
  stock               Int              @default(0)
  trackQuantity       Boolean          @default(true)
  isPreOrder          Boolean          @default(false)
  preOrderReleaseDate DateTime?
  image               String?
  mediaId             String?
  media               Media?           @relation(fields: [mediaId], references: [id])
  images              ProductImage[]
  weight              Decimal?         @db.Decimal(10, 3)
  length              Decimal?         @db.Decimal(10, 2)
  width               Decimal?         @db.Decimal(10, 2)
  height              Decimal?         @db.Decimal(10, 2)
  attributes          Json
  metafields          Json?
  version             Int              @default(1)
  inventoryLevels     InventoryLevel[]
  wishlistedBy        Wishlist[]
  recentViews         RecentlyViewed[]
  cartItems           CartItem[]
  orderItems          OrderItem[]
  deletedAt           DateTime?

  @@index([productId])
  @@index([sku])
  @@index([attributes(ops: JsonbPathOps)], type: Gin)
  @@index([productId, price])
  @@index([isPreOrder])
  @@index([deletedAt])
}

// ==========================================
// 6. INVENTORY & WAREHOUSING
// ==========================================

model Location {
  id              String          @id @default(uuid())
  name            String
  address         String?
  isDefault       Boolean         @default(false)
  isActive        Boolean         @default(true)
  inventoryLevels InventoryLevel[]
  stockTransfers  StockTransfer[] @relation("FromLocation")
  stockReceived   StockTransfer[] @relation("ToLocation")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model PickupLocation {
  id           String   @id @default(uuid())
  name         String
  address      String
  city         String
  state        String?
  postcode     String
  country      String   @default("AU")
  instructions String?
  isActive     Boolean  @default(true)
  orders       Order[]
  latitude     Float?
  longitude    Float?
  openingHours Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
}

model InventoryLevel {
  id         String          @id @default(uuid())
  quantity   Int             @default(0)
  locationId String
  location   Location        @relation(fields: [locationId], references: [id], onDelete: Cascade)
  productId  String
  product    Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId  String?
  variant    ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  version    Int             @default(1)

  @@unique([locationId, productId, variantId])
  @@index([productId, variantId])
  @@index([locationId])
  @@index([locationId, productId, quantity])
}

model Supplier {
  id             String          @id @default(uuid())
  name           String
  email          String?
  phone          String?
  address        String?
  website        String?
  contactPerson  String?
  purchaseOrders PurchaseOrder[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model PurchaseOrder {
  id         String   @id @default(uuid())
  poNumber   String   @unique
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  status     String
  totalCost  Decimal  @db.Decimal(12, 2)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([supplierId])
  @@index([status])
}

model StockTransfer {
  id             String   @id @default(uuid())
  reference      String   @unique
  fromLocationId String
  fromLocation   Location @relation("FromLocation", fields: [fromLocationId], references: [id])
  toLocationId   String
  toLocation     Location @relation("ToLocation", fields: [toLocationId], references: [id])
  status         String
  items          Json
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status])
  @@index([createdAt(sort: Desc)])
}

// ==========================================
// 7. SALES, ORDERS & RETURNS
// ==========================================

model Order {
  id                     String             @id @default(uuid())
  orderNumber            String             @unique
  orderDate              DateTime           @default(now())
  userId                 String?
  user                   User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  guestEmail             String?
  status                 OrderStatus        @default(PENDING)
  paymentStatus          PaymentStatus      @default(UNPAID)
  fulfillmentStatus      FulfillmentStatus  @default(UNFULFILLED)
  hasPreOrderItems       Boolean            @default(false)
  currency               String             @default("AUD")
  exchangeRate           Decimal            @default(1.0) @db.Decimal(10, 6)
  subtotal               Decimal            @db.Decimal(12, 2)
  discountTotal          Decimal            @default(0) @db.Decimal(12, 2)
  shippingTotal          Decimal            @default(0) @db.Decimal(12, 2)
  taxTotal               Decimal            @default(0) @db.Decimal(12, 2)
  surcharge              Decimal            @default(0) @db.Decimal(12, 2)
  total                  Decimal            @db.Decimal(12, 2)
  paymentFee             Decimal            @default(0) @db.Decimal(12, 2)
  netAmount              Decimal            @default(0) @db.Decimal(12, 2)
  refundedAmount         Decimal            @default(0) @db.Decimal(12, 2)
  netTotal               Decimal            @default(0) @db.Decimal(12, 2)
  paymentGateway         String?
  paymentMethod          String?
  paymentId              String?            @unique
  payerId                String?
  paymentVerified        Boolean            @default(false)
  invoiceNumber          String?
  invoiceUrl             String?
  couponCode             String?
  discountId             String?
  discount               Discount?          @relation(fields: [discountId], references: [id], onDelete: SetNull)
  discountDetails        Json?
  shippingAddress        Json
  billingAddress         Json
  shippingMethod         String?
  shippingType           ShippingMethodType @default(FLAT_RATE)
  shippingTrackingNumber String?
  shippingTrackingUrl    String?
  shippingProvider       String?
  pickupLocationId       String?
  pickupLocation         PickupLocation?    @relation(fields: [pickupLocationId], references: [id])
  transdirectBookingId   Int?
  transdirectOrderStatus String?
  transdirectQuoteId     String?
  transdirectBookingRef  String?
  authorityToLeave       Boolean            @default(false)
  tailgatePickup         Boolean            @default(false)
  tailgateDelivery       Boolean            @default(false)
  declaredValue          Decimal?           @db.Decimal(12, 2)
  isInsured              Boolean            @default(false)
  selectedCourierCode    String?
  selectedCourierService String?
  quoteTier              Int?               @default(1)
  pickupDate             DateTime?
  pickupReadyTime        String?
  pickupCloseTime        String?
  transdirectLabelUrl    String?
  transdirectInvoiceUrl  String?
  customerNote           String?
  adminNote              String?
  deliveryInstructions   String?
  estimatedTransitTime   String?
  ipAddress              String?
  userAgent              String?
  paymentIntentId        String?
  chargeId               String?
  isAuthorized           Boolean            @default(false)
  isCaptured             Boolean            @default(false)
  capturedAt             DateTime?
  riskLevel              String?
  riskScore              Int?
  fraudAnalysis          Json?
  
  affiliateId            String?
  affiliate              AffiliateAccount?  @relation("OrderAffiliate", fields: [affiliateId], references: [id], onDelete: SetNull)
  referral               Referral?

  items                  OrderItem[]
  shipments              Shipment[]
  transactions           OrderTransaction[]
  refunds                Refund[]
  returns                ReturnRequest[]
  disputes               Dispute[]
  orderNotes             OrderNote[]
  deletedAt              DateTime?
  version                Int                @default(1)
  
  // Audit fields
  createdBy              String?
  updatedBy              String?
  
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  @@index([userId, status])
  @@index([createdAt(sort: Desc)])
  @@index([status, createdAt])
  @@index([paymentStatus, createdAt])
  @@index([orderNumber])
  @@index([paymentId])
  @@index([orderDate])
  @@index([hasPreOrderItems])
  @@index([userId, status, createdAt])
  @@index([status, paymentStatus, fulfillmentStatus])
  @@index([status, createdAt, total])
  @@index([affiliateId])
  @@index([deletedAt])
  @@index([guestEmail])
}

model OrderItem {
  id                  String          @id @default(uuid())
  orderId             String
  order               Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId           String?
  product             Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  productName         String
  variantId           String?
  variant             ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantName         String?
  sku                 String?
  isPreOrder          Boolean         @default(false)
  preOrderReleaseDate DateTime?
  image               String?
  price               Decimal         @db.Decimal(12, 2)
  quantity            Int
  total               Decimal         @db.Decimal(12, 2)
  tax                 Decimal         @default(0) @db.Decimal(12, 2)
  metadata            Json?

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

model OrderTransaction {
  id                  String            @id @default(uuid())
  orderId             String
  order               Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  gateway             String
  type                TransactionType
  amount              Decimal           @db.Decimal(12, 2)
  currency            String            @default("AUD")
  transactionId       String
  idempotencyKey      String?
  status              String
  parentTransactionId String?
  parentTransaction   OrderTransaction? @relation("RefundOf", fields: [parentTransactionId], references: [id], onDelete: SetNull)
  refunds             OrderTransaction[] @relation("RefundOf")
  rawResponse         Json?
  errorCode           String?
  errorMessage        String?
  metadata            Json?
  createdAt           DateTime          @default(now())

  @@index([orderId, status])
  @@index([transactionId])
  @@index([gateway, transactionId])
  @@index([createdAt(sort: Desc)])
}

model Dispute {
  id               String        @id @default(uuid())
  orderId          String
  order            Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  gatewayDisputeId String        @unique
  reason           String?
  status           DisputeStatus @default(WARNING_NEEDS_RESPONSE)
  amount           Decimal       @db.Decimal(12, 2)
  currency         String        @default("AUD")
  evidenceDueBy    DateTime?
  metadata         Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([orderId])
  @@index([status])
}

model Payout {
  id          String   @id @default(uuid())
  gateway     String
  payoutId    String   @unique
  amount      Decimal  @db.Decimal(12, 2)
  currency    String
  status      String
  arrivalDate DateTime
  details     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
}

model PaymentWebhookLog {
  id              String   @id @default(uuid())
  provider        String
  eventId         String
  eventType       String
  payload         Json
  processed       Boolean  @default(false)
  processingError String?
  createdAt       DateTime @default(now())

  @@unique([eventId])
  @@index([provider, processed])
  @@index([createdAt(sort: Desc)])
}

model Shipment {
  id                 String   @id @default(uuid())
  orderId            String
  order              Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  trackingNumber     String?
  trackingUrl        String?
  courier            String?
  items              Json
  shippedDate        DateTime @default(now())
  deliveredDate      DateTime?
  transdirectId      Int?
  connote            String?
  labelUrl           String?
  invoiceUrl         String?
  courierName        String?
  lastTrackingStatus String?
  courierJobId       String?
  manifestId         String?
  numberOfParcels    Int      @default(1)
  syncedToGateway    Boolean  @default(false)
  syncError          String?
  lastSyncedAt       DateTime?
  rawStatus          Json?

  @@index([orderId])
  @@index([trackingNumber])
}

model ReturnRequest {
  id        String       @id @default(uuid())
  orderId   String
  order     Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    ReturnStatus @default(REQUESTED)
  reason    String
  adminNote String?
  refunded  Boolean      @default(false)
  items     Json
  images    String[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([orderId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model Refund {
  id              String   @id @default(uuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount          Decimal  @db.Decimal(12, 2)
  reason          String?
  status          String   @default("pending")
  gatewayRefundId String?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orderId])
  @@index([status])
}

model OrderNote {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  content   String
  isSystem  Boolean  @default(false)
  notify    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([createdAt(sort: Desc)])
}

// ==========================================
// 8. CART, WISHLIST & ABANDONED CHECKOUT
// ==========================================

model Cart {
  id             String     @id @default(uuid())
  userId         String?    @unique
  user           User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId      String?
  items          CartItem[]
  reminderSentAt DateTime?
  updatedAt      DateTime   @updatedAt

  @@index([sessionId])
  @@index([userId])
  @@index([updatedAt(sort: Desc)])
}

model CartItem {
  id        String          @id @default(uuid())
  cartId    String
  cart      Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  quantity  Int

  @@index([cartId])
  @@index([productId])
}

model AbandonedCheckout {
  id            String    @id @default(uuid())
  cartToken     String?
  email         String?
  userId        String?
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  items         Json
  subtotal      Decimal   @db.Decimal(12, 2)
  currency      String    @default("AUD")
  recoveryUrl   String
  isRecovered   Boolean   @default(false)
  recoveredAt   DateTime?
  remindersSent Int       @default(0)
  lastReminder  DateTime?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([isRecovered])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
}

model Wishlist {
  id        String          @id @default(uuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  createdAt DateTime        @default(now())

  @@unique([userId, productId, variantId])
  @@index([userId])
  @@index([productId])
}

model RecentlyViewed {
  id        String          @id @default(uuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  viewedAt  DateTime        @default(now())

  @@index([userId, viewedAt(sort: Desc)])
  @@index([productId])
}

// ==========================================
// 9. MARKETING & DISCOUNTS
// ==========================================

model Discount {
  id               String       @id @default(uuid())
  code             String       @unique
  description      String?
  type             DiscountType @default(PERCENTAGE)
  value            Decimal      @db.Decimal(12, 2)
  minSpend         Decimal?     @db.Decimal(12, 2)
  maxSpend         Decimal?     @db.Decimal(12, 2)
  minQty           Int?
  startDate        DateTime     @default(now())
  endDate          DateTime?
  usageLimit       Int?
  usagePerUser     Int?
  usedCount        Int          @default(0)
  excludeSaleItems Boolean      @default(false)
  productIds       String[]
  categoryIds      String[]
  ruleLogic        Json?
  isActive         Boolean      @default(true)
  orders           Order[]
  
  affiliateId      String?
  affiliate        AffiliateAccount? @relation(fields: [affiliateId], references: [id], onDelete: SetNull)

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([code])
  @@index([startDate, endDate])
  @@index([isActive])
  @@index([affiliateId])
}

model GiftCard {
  id             String    @id @default(uuid())
  code           String    @unique
  initialValue   Decimal   @db.Decimal(12, 2)
  balance        Decimal   @db.Decimal(12, 2)
  userId         String?
  recipientEmail String?
  expiresAt      DateTime?
  isEnabled      Boolean   @default(true)
  createdAt      DateTime  @default(now())

  @@index([code])
  @@index([userId])
}

model Newsletter {
  id        String   @id @default(uuid())
  email     String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([isActive])
}

// ==========================================
// 10. CMS & SYSTEM
// ==========================================

model BlogPost {
  id              String   @id @default(uuid())
  title           String
  slug            String   @unique
  content         String   @db.Text
  excerpt         String?
  image           String?
  featuredMediaId String?
  featuredMedia   Media?   @relation(fields: [featuredMediaId], references: [id])
  authorId        String
  author          User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  isPublished     Boolean  @default(false)
  tags            String[]
  metaTitle       String?
  metaDesc        String?
  
  // FIXED: Vector embedding
  contentEmbedding Unsupported("vector(1536)")?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([isPublished, createdAt(sort: Desc)])
  @@index([authorId])
}

model Page {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  content     String   @db.Text
  metaTitle   String?
  metaDesc    String?
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([isPublished])
}

model Menu {
  id        String   @id @default(uuid())
  title     String
  slug      String   @unique
  items     Json
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
}

model Review {
  id         String   @id @default(uuid())
  rating     Int
  title      String?
  content    String?  @db.Text
  isVerified Boolean  @default(false)
  status     String   @default("pending")
  images     String[]
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  reply      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([productId])
  @@index([status])
  @@index([rating])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
}

model QuestionAnswer {
  id         String   @id @default(uuid())
  question   String
  answer     String?
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId     String?
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([productId])
  @@index([isApproved])
}

model SupportTicket {
  id           String          @id @default(uuid())
  subject      String
  status       String          @default("open")
  priority     String          @default("medium")
  userId       String
  user         User            @relation("UserCreatedTickets", fields: [userId], references: [id], onDelete: Cascade)
  assignedToId String?
  assignedTo   User?           @relation("StaffTickets", fields: [assignedToId], references: [id], onDelete: SetNull)
  messages     TicketMessage[]
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([userId])
  @@index([status])
  @@index([assignedToId])
  @@index([createdAt(sort: Desc)])
}

model TicketMessage {
  id         String        @id @default(uuid())
  ticketId   String
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  senderId   String
  message    String        @db.Text
  attachment String?
  createdAt  DateTime      @default(now())

  @@index([ticketId, createdAt(sort: Asc)])
}

// ==========================================
// 11. SETTINGS & ADVANCED CONFIGURATIONS
// ==========================================

model StoreSettings {
  id             String              @id @default("settings")
  storeName      String              @default("My Store")
  storeEmail     String?
  storePhone     String?
  currency       String              @default("AUD")
  currencySymbol String              @default("$")
  storeAddress   Json?
  taxSettings    Json?
  generalConfig  Json?
  weightUnit     String              @default("kg")
  dimensionUnit  String              @default("cm")
  logo           String?
  favicon        String?
  logoMediaId    String?
  logoMedia      Media?              @relation("StoreLogo", fields: [logoMediaId], references: [id])
  faviconMediaId String?
  faviconMedia   Media?              @relation("StoreFavicon", fields: [faviconMediaId], references: [id])
  socialLinks    Json?
  smtpConfig     Json?
  maintenance    Boolean             @default(false)
  affiliateConfig Json?
  mlmConfig       Json?
  updatedAt      DateTime            @default(now()) @updatedAt
}

// ==========================================
// 12. TAX, SHIPPING & TRANSDIRECT
// ==========================================

model TaxRate {
  id       String    @id @default(uuid())
  name     String    @default("GST")
  rate     Decimal   @default(10.0) @db.Decimal(5, 2)
  country  String?   @default("AU")
  state    String?
  priority Int       @default(0)
  compound Boolean   @default(false)
  shipping Boolean   @default(true)
  class    String    @default("STANDARD")
  products Product[]
  isActive Boolean   @default(true)

  @@index([isActive])
  @@index([country, state])
}

model ShippingZone {
  id        String         @id @default(uuid())
  name      String
  countries String[]
  rates     ShippingRate[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model ShippingRate {
  id                      String             @id @default(uuid())
  zoneId                  String
  zone                    ShippingZone       @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  name                    String
  type                    ShippingMethodType @default(FLAT_RATE)
  price                   Decimal            @db.Decimal(12, 2)
  minWeight               Decimal?           @db.Decimal(10, 3)
  maxWeight               Decimal?           @db.Decimal(10, 3)
  minPrice                Decimal?           @db.Decimal(12, 2)
  taxStatus               String             @default("taxable")
  freeShippingRequirement String?
  carrierServiceId        String?
  carrierService          CarrierService?    @relation(fields: [carrierServiceId], references: [id], onDelete: SetNull)
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt

  @@index([zoneId])
}

model CarrierService {
  id               String          @id @default(uuid())
  name             String
  slug             String          @unique
  isEnabled        Boolean         @default(false)
  apiKey           String?
  apiSecret        String?
  isSandbox        Boolean         @default(true)
  settings         Json?
  rates            ShippingRate[]
  shippingPackages ShippingBox[]
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([slug])
  @@index([isEnabled])
}

model TransdirectConfig {
  id                      String   @id @default("transdirect_config")
  isEnabled               Boolean  @default(false)
  email                   String?
  password                String?
  apiKey                  String?
  memberId                Int?
  creditLimit             Decimal? @db.Decimal(12, 2)
  accountStatus           String?
  senderName              String?
  senderCompany           String?
  senderPhone             String?
  senderAddress           String?
  senderSuburb            String?
  senderPostcode          String?
  senderState             String?
  senderCountry           String?  @default("AU")
  senderType              String   @default("business")
  defaultTailgatePickup   Boolean  @default(false)
  defaultTailgateDelivery Boolean  @default(false)
  defaultDeclaredValue    Boolean  @default(true)
  defaultPickupReadyTime  String   @default("09:00")
  defaultPickupCloseTime  String   @default("17:00")
  useFrequentRates        Boolean  @default(false)
  enableOrderBoxing       Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @default(now()) @updatedAt
}

model TransdirectBox {
  id          String   @id @default(uuid())
  code        String?
  description String?
  length      Decimal  @db.Decimal(10, 2)
  width       Decimal  @db.Decimal(10, 2)
  height      Decimal  @db.Decimal(10, 2)
  maxWeight   Decimal? @db.Decimal(10, 3)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

model ShippingBox {
  id               String          @id @default(uuid())
  name             String
  length           Decimal         @db.Decimal(10, 2)
  width            Decimal         @db.Decimal(10, 2)
  height           Decimal         @db.Decimal(10, 2)
  weight           Decimal?        @db.Decimal(10, 3)
  maxWeight        Decimal?        @db.Decimal(10, 3)
  isEnabled        Boolean         @default(true)
  carrierServiceId String?
  carrierService   CarrierService? @relation(fields: [carrierServiceId], references: [id], onDelete: SetNull)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([isEnabled])
}

// ==========================================
// 13. EMAIL & NOTIFICATION SYSTEM
// ==========================================

model EmailConfiguration {
  id                  String   @id @default("email_config")
  senderName          String   @default("GoBike")
  senderEmail         String   @default("gobike@gobike.au")
  smtpHost            String?
  smtpPort            Int?     @default(587)
  smtpUser            String?
  smtpPassword        String?
  encryption          String?  @default("tls")
  headerImage         String?
  mediaId             String?
  media               Media?   @relation(fields: [mediaId], references: [id])
  footerText          String?  @default(" 2025 GoBike. All rights reserved.")
  baseColor           String?  @default("#2271b1")
  backgroundColor     String?  @default("#F7F7F7")
  bodyBackgroundColor String?  @default("#FFFFFF")
  isActive            Boolean  @default(true)
  updatedAt           DateTime @default(now()) @updatedAt
}

model EmailTemplate {
  id               String   @id @default(uuid())
  slug             String   @unique
  triggerEvent     String?  @unique
  name             String
  subject          String
  heading          String?
  content          String   @db.Text
  isEnabled        Boolean  @default(true)
  recipientType    String   @default("customer")
  customRecipients String?
  cc               String[]
  bcc              String[]
  attachments      String[]
  emailType        String   @default("html")
  fromName         String?
  fromEmail        String?
  delay            Int?     @default(0) 
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([slug])
  @@index([isEnabled])
}

model NotificationQueue {
  id           String              @id @default(uuid())
  channel      NotificationChannel @default(EMAIL)
  recipient    String
  subject      String?
  content      String              @db.Text
  templateSlug String?
  metadata     Json?
  status       NotificationStatus  @default(PENDING)
  attempts     Int                 @default(0)
  maxAttempts  Int                 @default(3)
  scheduledAt  DateTime            @default(now())
  sentAt       DateTime?
  error        String?
  orderId      String?
  userId       String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([status])
  @@index([scheduledAt])
  @@index([status, scheduledAt])
}

model EmailLog {
  id           String   @id @default(uuid())
  recipient    String
  subject      String
  templateSlug String?
  status       String
  errorMessage String?
  metadata     Json?
  openedAt     DateTime?
  orderId      String?
  userId       String?
  createdAt    DateTime @default(now())

  @@index([recipient])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String
  entityType String?
  entityId   String?
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?
  type      String?
  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt(sort: Desc)])
}

model Analytics {
  id          String   @id @default(uuid())
  date        DateTime @default(now()) @db.Date
  totalSales  Decimal  @default(0) @db.Decimal(12, 2)
  totalOrders Int      @default(0)
  visitors    Int      @default(0)

  @@unique([date])
  @@index([date, totalSales])
}

model MediaFolder {
  id        String        @id @default(uuid())
  name      String
  parentId  String?
  parent    MediaFolder?  @relation("FolderToFolder", fields: [parentId], references: [id], onDelete: SetNull)
  children  MediaFolder[] @relation("FolderToFolder")
  files     Media[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([parentId])
}

model Media {
  id             String               @id @default(uuid())
  url            String
  type           MediaType            @default(IMAGE)
  filename       String
  originalName   String?
  publicId       String?
  width          Int?
  height         Int?
  mimeType       String
  size           Int
  altText        String?
  caption        String?
  description    String?
  folderId       String?
  folder         MediaFolder?         @relation(fields: [folderId], references: [id], onDelete: SetNull)
  uploadedBy     String
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  productImages  ProductImage[]
  categories     Category[]
  brands         Brand[]
  products       Product[]
  variants       ProductVariant[]
  blogPosts      BlogPost[]
  
  storeLogos     StoreSettings[]      @relation("StoreLogo")
  storeFavicons  StoreSettings[]      @relation("StoreFavicon")
  users          User[]
  collections    Collection[]
  banners        Banner[]
  emailConfigs   EmailConfiguration[]
  seoConfigs     SeoGlobalConfig[]

  @@index([folderId])
  @@index([createdAt(sort: Desc)])
  @@index([type])
}

model UrlRedirect {
  id        String   @id @default(uuid())
  source    String   @unique
  target    String
  code      Int      @default(301)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([source])
  @@index([isActive])
}

model SeoGlobalConfig {
  id                String   @id @default("global_seo")
  siteName          String   @default("GoBike")
  titleSeparator    String   @default("|")
  siteUrl           String   @default("https://gobike.au")
  organizationData  Json?    @db.JsonB
  defaultMetaTitle  String?
  defaultMetaDesc   String?  @db.Text
  defaultKeywords   String[]
  robotsTxtContent  String?  @db.Text
  globalRobotsProps Json?
  sitemapEnabled    Boolean  @default(true)
  isPublic          Boolean  @default(true)
  ogImage           String?
  ogMediaId         String?
  ogMedia           Media?   @relation(fields: [ogMediaId], references: [id])
  ogImageWidth      Int?     @default(1200)
  ogImageHeight     Int?     @default(630)
  ogType            String   @default("website")
  ogLocale          String   @default("en_AU")
  twitterCard       String   @default("summary_large_image")
  twitterSite       String?
  twitterCreator    String?
  themeColor        String?  @default("#2271b1")
  manifestJson      Json?
  updatedAt         DateTime @default(now()) @updatedAt
}

model MarketingIntegration {
  id                        String   @id @default("marketing_config")
  gtmEnabled                Boolean  @default(false)
  gtmContainerId            String?
  gtmAuth                   String?
  gtmPreview                String?
  dataLayerName             String   @default("dataLayer")
  gscVerificationCode       String?
  gscServiceAccountJson     String?  @db.Text
  gmcMerchantId             String?
  gmcTargetCountry          String   @default("AU")
  gmcLanguage               String   @default("en")
  gmcContentApiEnabled      Boolean  @default(false)
  fbPixelId                 String?
  fbEnabled                 Boolean  @default(false)
  fbAccessToken             String?  @db.Text
  fbTestEventCode           String?
  fbDataProcessingOptions   Json?
  fbDomainVerification      String?
  klaviyoEnabled            Boolean  @default(false)
  klaviyoPublicKey          String?
  klaviyoPrivateKey         String?  @db.Text
  klaviyoListIds            Json?
  klaviyoTrackViewedProduct Boolean  @default(true)
  klaviyoTrackAddedToCart   Boolean  @default(true)
  verificationStatus        Json?    @default("{}")
  updatedAt                 DateTime @default(now()) @updatedAt
}

model Banner {
  id        String   @id @default(uuid())
  title     String
  image     String
  mediaId   String?
  media     Media?   @relation(fields: [mediaId], references: [id])
  link      String?
  position  Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, position(sort: Asc)])
}

model SystemLog {
  id        String   @id @default(uuid())
  level     String
  source    String
  message   String   @db.Text
  context   Json?
  createdAt DateTime @default(now())

  @@index([source])
  @@index([createdAt(sort: Desc)])
  @@index([level])
}

// ==========================================
// 15. PAYMENT CONFIGURATION
// ==========================================

model PaymentMethodConfig {
  id                   String                @id @default(uuid())
  identifier           String                @unique
  name                 String
  isEnabled            Boolean               @default(false)
  mode                 PaymentMode           @default(TEST)
  displayOrder         Int                   @default(0)
  description          String?
  instructions         String?
  icon                 String?
  minOrderAmount       Decimal?              @db.Decimal(12, 2)
  maxOrderAmount       Decimal?              @db.Decimal(12, 2)
  surchargeEnabled     Boolean               @default(false)
  surchargeType        String                @default("fixed")
  surchargeAmount      Decimal               @default(0) @db.Decimal(12, 2)
  taxableSurcharge     Boolean               @default(false)
  needsSetup           Boolean               @default(true)
  stripeConfig         StripeConfig?
  paypalConfig         PaypalConfig?
  offlineConfig        OfflinePaymentConfig?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@index([isEnabled, displayOrder(sort: Asc)])
  @@index([identifier])
}

model StripeConfig {
  id                        String              @id @default(uuid())
  paymentMethodId           String              @unique
  paymentMethod             PaymentMethodConfig @relation(fields: [paymentMethodId], references: [id], onDelete: Cascade)
  enableStripe              Boolean             @default(true)
  testMode                  Boolean             @default(false)
  title                     String              @default("Credit Card / Debit Card")
  description               String              @default("Pay securely with your credit card via Stripe.")
  isConnected               Boolean             @default(false)
  accountId                 String?
  oauthAccessToken          String?             @db.Text
  oauthRefreshToken         String?             @db.Text
  oauthTokenType            String?
  livePublishableKey        String?             @db.Text
  liveSecretKey             String?             @db.Text
  liveWebhookSecret         String?             @db.Text
  testPublishableKey        String?             @db.Text
  testSecretKey             String?             @db.Text
  testWebhookSecret         String?             @db.Text
  paymentAction             PaymentIntent       @default(CAPTURE)
  statementDescriptor       String?
  shortStatementDescriptor  String?
  addOrderNumberToStatement Boolean             @default(false)
  savedCards                Boolean             @default(true)
  inlineCreditCardForm      Boolean             @default(true)
  applePayEnabled           Boolean             @default(true)
  googlePayEnabled          Boolean             @default(true)
  klarnaEnabled             Boolean             @default(true)
  afterpayEnabled           Boolean             @default(true)
  zipEnabled                Boolean             @default(true)
  paymentRequestButtons     Boolean             @default(true)
  buttonTheme               String              @default("dark")
  debugLog                  Boolean             @default(true)
  updatedAt                 DateTime            @updatedAt
}

model PaypalConfig {
  id                       String              @id @default(uuid())
  paymentMethodId          String              @unique
  paymentMethod            PaymentMethodConfig @relation(fields: [paymentMethodId], references: [id], onDelete: Cascade)
  enablePaypal             Boolean             @default(true)
  sandbox                  Boolean             @default(false)
  isOnboarded              Boolean             @default(false)
  merchantId               String?
  accessToken              String?             @db.Text
  refreshToken             String?             @db.Text
  tokenExpiry              DateTime?
  tokenType                String?
  partnerReferralId        String?
  liveEmail                String?
  liveClientId             String?             @db.Text
  liveClientSecret         String?             @db.Text
  sandboxEmail             String?
  sandboxClientId          String?             @db.Text
  sandboxClientSecret      String?             @db.Text
  title                    String              @default("PayPal")
  description              String              @default("Pay via PayPal; you can pay with your credit card if you don't have a PayPal account.")
  intent                   PaymentIntent       @default(CAPTURE)
  instantPayments          Boolean             @default(false)
  brandName                String?
  landingPage              PayPalLandingPage   @default(LOGIN)
  disableFunding           String[]
  advancedCardEnabled      Boolean             @default(false)
  advancedCardTitle        String              @default("Debit & Credit Cards")
  vaultingEnabled          Boolean             @default(false)
  smartButtonLocations     String[]
  requireFinalConfirmation Boolean             @default(true)
  buttonLabel              PayPalButtonLabel   @default(PAYPAL)
  buttonLayout             PayPalButtonLayout  @default(VERTICAL)
  buttonColor              PayPalButtonColor   @default(GOLD)
  buttonShape              PayPalButtonShape   @default(RECT)
  payLaterEnabled          Boolean             @default(true)
  payLaterLocations        String[]
  payLaterMessaging        Boolean             @default(true)
  payLaterMessageTheme     String              @default("light")
  subtotalMismatchBehavior String              @default("add_line_item")
  invoicePrefix            String?             @default("wc-")
  debugLog                 Boolean             @default(false)
  webhookId                String?             @unique
  webhookUrl               String?             @db.Text
  updatedAt                DateTime            @updatedAt
}

model OfflinePaymentConfig {
  id                       String              @id @default(uuid())
  paymentMethodId          String              @unique
  paymentMethod            PaymentMethodConfig @relation(fields: [paymentMethodId], references: [id], onDelete: Cascade)
  bankDetails              Json?
  chequePayTo              String?
  addressInfo              String?
  enableForShippingMethods String[]
}

// ==========================================
// 16. AUDIT & ADVANCED EVENTS
// ==========================================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  tableName String
  recordId  String
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([tableName, recordId])
  @@index([userId, createdAt])
  @@index([createdAt(sort: Desc)])
}

model OutboxEvent {
  id          String      @id @default(uuid())
  aggregateId String
  type        String
  payload     Json
  status      EventStatus @default(PENDING)
  attempts    Int         @default(0)
  lastError   String?
  createdAt   DateTime    @default(now())
  processedAt DateTime?

  @@index([status, createdAt])
  @@index([aggregateId])
}

// ==========================================
// 17. AFFILIATE SYSTEM (ULTRA & MLM)
// ==========================================

model AffiliateAccount {
  id              String           @id @default(uuid())
  userId          String           @unique
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  slug            String           @unique
  customSlug      String?          @unique 
  status          AffiliateStatus  @default(PENDING)
  commissionRate  Decimal?         @db.Decimal(5, 2)
  commissionType  CommissionType   @default(PERCENTAGE)      
  balance         Decimal          @default(0.00) @db.Decimal(12, 2)
  totalEarnings   Decimal          @default(0.00) @db.Decimal(12, 2)
  storeCredit     Decimal          @default(0.00) @db.Decimal(12, 2)
  
  isLifetime        Boolean   @default(false)      
  cookieDuration    Int?      @default(30)         
  riskScore         Float     @default(0.0)        
  autoApprovePayout Boolean   @default(false)
  
  kycStatus       String   @default("NOT_SUBMITTED")
  taxId           String?
  groupId         String?
  group           AffiliateGroup?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  documents       AffiliateDocument[]
  
  campaigns         AffiliateCampaign[]        
  shortLinks        AffiliateLink[]              
  ledger            AffiliateLedger[] 
  productRates      AffiliateProductRate[]
  tags              AffiliateTag[]
  
  tierId          String?
  tier            AffiliateTier?   @relation(fields: [tierId], references: [id], onDelete: SetNull)
  
  // FIXED: MLM Tree with materialized path for better performance
  parentId        String?
  parent          AffiliateAccount? @relation("AffiliateMLM", fields: [parentId], references: [id], onDelete: SetNull)
  downlines       AffiliateAccount[] @relation("AffiliateMLM")
  mlmPath         String?          // e.g., "root.user1.user2" for fast ancestor queries
  mlmLevel        Int       @default(0)
  
  referrals       Referral[]
  customerReferrals User[]         @relation("CustomerReferral")
  clicks          AffiliateClick[]
  payouts         AffiliatePayout[]
  pixels          AffiliatePixel[]
  domains         AffiliateDomain[]
  orders          Order[]          @relation("OrderAffiliate")
  coupons         Discount[]
  creativeUsages  AffiliateCreativeUsage[] 
  
  bankDetails     Json?
  paypalEmail     String?
  registrationNotes String?        @db.Text
  adminNotes        String?        @db.Text
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([slug])
  @@index([status])
  @@index([parentId])
  @@index([customSlug])
  @@index([mlmPath])
  @@index([mlmLevel])
  @@index([groupId])
  @@index([tierId])
}

model AffiliateDocument {
  id              String   @id @default(uuid())
  affiliateId     String
  affiliate       AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  type            String
  documentNumber  String?
  fileUrl         String
  status          String   @default("PENDING")
  rejectionReason String?
  verifiedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([affiliateId])
  @@index([status])
}

model AffiliateTier {
  id              String             @id @default(uuid())
  name            String             @unique
  description     String?
  commissionRate  Decimal            @db.Decimal(5, 2)
  commissionType  CommissionType     @default(PERCENTAGE)
  minSalesAmount  Decimal            @default(0) @db.Decimal(12, 2)
  minSalesCount   Int                @default(0)
  color           String?
  icon            String?
  isDefault       Boolean            @default(false)
  payoutDelayDays Int                @default(30)
  affiliates      AffiliateAccount[]
  announcements   AffiliateAnnouncement[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([isDefault])
}

model AffiliateClick {
  id              String           @id @default(uuid())
  affiliateId     String
  affiliate       AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  ipAddress       String?
  userAgent       String?
  referrer        String?
  landingPage     String?
  subId           String?
  campaign        String?
  country         String?
  deviceType      String?
  converted       Boolean          @default(false)
  orderId         String?
  utmSource         String?                       
  utmMedium         String?                    
  utmCampaign       String?                    
  deviceFingerprint String?                     
  city              String?                    
  processingTime    Int? 
  createdAt       DateTime         @default(now())
  conversionStatus String          @default("PENDING")

  @@index([affiliateId])
  @@index([subId])
  @@index([createdAt])
  @@index([ipAddress])
  @@index([deviceFingerprint])
  @@index([converted])
}

model Referral {
  id              String           @id @default(uuid())
  affiliateId     String
  affiliate       AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  orderId         String           @unique
  order           Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  totalOrderAmount Decimal         @db.Decimal(12, 2)
  netOrderAmount  Decimal          @db.Decimal(12, 2)
  commissionAmount Decimal         @db.Decimal(12, 2)
  currency        String           @default("AUD")
  status          ReferralStatus   @default(PENDING)
  tierSnapshot    String?
  commissionType  CommissionType   @default(PERCENTAGE)
  commissionRate  Decimal          @db.Decimal(5, 2)
  isMlmReward     Boolean          @default(false)
  isLifetime      Boolean          @default(false)
  isManual        Boolean          @default(false) 
  adminNote       String?
  fromDownlineId  String?
  metadata        Json?
  availableAt     DateTime?

  commissionRuleId  String?                       
  matchedRule       AffiliateCommissionRule?      @relation(fields: [commissionRuleId], references: [id], onDelete: SetNull)
  
  isRecurring       Boolean   @default(false)    
  recurringCycle    Int?      @default(1)         
  
  deviceFingerprint String?                       
  isFlagged         Boolean   @default(false)     
  flagReason        String?   

  paidAt          DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([affiliateId])
  @@index([status])
  @@index([createdAt])
  @@index([paidAt])
  @@index([isFlagged])
}

model AffiliatePayout {
  id              String           @id @default(uuid())
  affiliateId     String
  affiliate       AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  amount          Decimal          @db.Decimal(12, 2)
  method          PayoutMethod
  status          PayoutStatus     @default(PENDING)
  bulkPayoutId    String?
  transactionId   String?
  invoiceUrl      String?
  note            String?
  processedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([affiliateId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model AffiliateDomain {
  id              String           @id @default(uuid())
  affiliateId     String
  affiliate       AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  
  domain          String           @unique 
  isVerified      Boolean          @default(false)
  verificationToken String?
  
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  
  @@index([domain])
  @@index([affiliateId])
}

model AffiliateCreative {
  id              String   @id @default(uuid())
  title           String
  description     String?
  type            MediaType @default(IMAGE)
  url             String
  width           Int?
  height          Int?
  targetUrl       String?
  textContent     String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  usages          AffiliateCreativeUsage[]
  usageCount      Int      @default(0)

  @@index([isActive])
}

model AffiliateCreativeUsage {
  id          String           @id @default(uuid())
  creativeId  String
  creative    AffiliateCreative @relation(fields: [creativeId], references: [id], onDelete: Cascade)
  affiliateId String
  affiliate   AffiliateAccount  @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  copiedAt    DateTime          @default(now())
  
  @@index([creativeId])
  @@index([affiliateId])
}

model AffiliatePixel {
  id              String           @id @default(uuid())
  affiliateId     String
  affiliate       AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  type            String           
  pixelId         String
  accessToken     String?          @db.Text
  testCode        String?
  isEnabled       Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([affiliateId])
  @@index([isEnabled])
}

model AffiliateContest {
  id              String   @id @default(uuid())
  title           String
  description     String?
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean  @default(true)
  prizes          Json?
  criteria        String   @default("sales_amount")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
  @@index([startDate, endDate])
}

model AffiliateCommissionRule {
  id              String    @id @default(uuid())
  name            String    
  priority        Int       @default(0)
  isActive        Boolean   @default(true)
  conditions      Json      
  action          Json      
  startDate       DateTime?
  endDate         DateTime?
  affiliateSpecificIds String[]
  referrals       Referral[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([isActive, priority(sort: Desc)])
  @@index([startDate, endDate])
}

model AffiliateLink {
  id              String           @id @default(uuid())
  affiliateId     String
  affiliate       AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  slug            String           @unique
  destinationUrl  String           
  campaignId      String?
  campaign        AffiliateCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  clickCount      Int              @default(0)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  
  @@index([slug])
  @@index([affiliateId])
  @@index([isActive])
}

model AffiliateCampaign {
  id              String           @id @default(uuid())
  name            String           
  affiliateId     String
  affiliate       AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  clicks          Int              @default(0)
  conversions     Int              @default(0)
  revenue         Decimal          @default(0.00) @db.Decimal(12, 2)
  links           AffiliateLink[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([affiliateId])
}

model AffiliateLedger {
  id              String           @id @default(uuid())
  affiliateId     String
  affiliate       AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  type            LedgerType       
  amount          Decimal          @db.Decimal(12, 2)
  balanceBefore   Decimal          @db.Decimal(12, 2)
  balanceAfter    Decimal          @db.Decimal(12, 2)
  referenceId     String?          
  description     String?
  createdAt       DateTime         @default(now())
  
  @@index([affiliateId])
  @@index([createdAt(sort: Desc)])
  @@index([type])
}

model AffiliateAnnouncement {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text
  type        String   @default("INFO")
  isActive    Boolean  @default(true)
  startsAt    DateTime @default(now())
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  targetTiers     AffiliateTier[]
  targetGroups    AffiliateGroup[]

  @@index([isActive])
  @@index([startsAt, expiresAt])
}

model AffiliateFraudRule {
  id          String   @id @default(uuid())
  type        String   
  value       String   
  action      String   @default("BLOCK")
  reason      String?
  createdAt   DateTime @default(now())

  @@index([type])
}

// ==========================================
// NEW: AFFILIATE GROUPS & TAGS
// ==========================================

model AffiliateGroup {
  id             String             @id @default(uuid())
  name           String             @unique
  slug           String             @unique
  description    String?
  commissionRate Decimal?           @db.Decimal(5, 2)
  isDefault      Boolean            @default(false)
  isActive       Boolean            @default(true)
  
  affiliates     AffiliateAccount[]
  productRates   AffiliateProductRate[]
  announcements  AffiliateAnnouncement[]
  
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([slug])
  @@index([isActive])
  @@index([isDefault])
}

model AffiliateTag {
  id         String             @id @default(uuid())
  name       String             @unique
  affiliates AffiliateAccount[]
  createdAt  DateTime           @default(now())

  @@index([name])
}

// ==========================================
// NEW: PRODUCT SPECIFIC RATES
// ==========================================

model AffiliateProductRate {
  id             String           @id @default(uuid())
  productId      String
  product        Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  affiliateId    String?
  affiliate      AffiliateAccount? @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  groupId        String?
  group          AffiliateGroup?   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  rate           Decimal          @db.Decimal(5, 2)
  type           CommissionType   @default(FIXED) 
  isDisabled     Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([productId])
  @@index([affiliateId])
  @@index([groupId])
  @@index([isDisabled])
}

// ==========================================
// NEW: MLM CONFIGURATION (Dynamic Levels)
// ==========================================

model AffiliateMLMConfig {
  id             String   @id @default("mlm_config")
  isEnabled      Boolean  @default(false)
  maxLevels      Int      @default(3)
  levelRates     Json     // e.g., {"1": 10, "2": 5, "3": 2}
  commissionBasis String  @default("SALES_AMOUNT") 
  updatedAt      DateTime @default(now()) @updatedAt
}
